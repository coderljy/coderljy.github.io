<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<!-- iOS Safari -->
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<!-- Chrome, Firefox OS and Opera Status Bar Color -->
<meta name="theme-color" content="#FFFFFF">
<link rel="stylesheet" type="text/css" href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.11.1/katex.min.css">
<link rel="stylesheet" type="text/css"
  href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.19.0/themes/prism.min.css">
<link rel="stylesheet" type="text/css" href="css/SourceSansPro.css">
<link rel="stylesheet" type="text/css" href="css/theme.css">
<link rel="stylesheet" type="text/css" href="css/notablog.css">
<!-- Favicon -->

  <link rel="shortcut icon" href="data:image/svg+xml,&lt;svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22&gt;&lt;text text-anchor=%22middle%22 dominant-baseline=%22middle%22 x=%2250%22 y=%2255%22 font-size=%2280%22&gt;📖&lt;/text&gt;&lt;/svg&gt;">

<style>
  :root {
    font-size: 20px;
  }
</style>
  <title>分布式事务&nbsp;|&nbsp;夕的博客</title>
  <meta property="og:type" content="blog">
  <meta property="og:title" content="分布式事务">
  
  
  <style>
    .DateTagBar {
      margin-top: 1.0rem;
    }
  </style>
</head>

<body>
  <nav class="Navbar">
  <a href="index.html">
    <div class="Navbar__Btn">
      
        <span><img class="inline-img-icon" src="data:image/svg+xml,&lt;svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22&gt;&lt;text text-anchor=%22middle%22 dominant-baseline=%22middle%22 x=%2250%22 y=%2255%22 font-size=%2280%22&gt;📖&lt;/text&gt;&lt;/svg&gt;"></span>&nbsp;
      
      <span>Home</span>
    </div>
  </a>
  
    
  
    
      <span class="Navbar__Delim">&centerdot;</span>
      <a href="about.html">
        <div class="Navbar__Btn">
          
            <span><img class="inline-img-icon" src="data:image/svg+xml,&lt;svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22&gt;&lt;text text-anchor=%22middle%22 dominant-baseline=%22middle%22 x=%2250%22 y=%2255%22 font-size=%2280%22&gt;😀&lt;/text&gt;&lt;/svg&gt;"></span>&nbsp;
          
          <span>About</span>
        </div>
      </a>
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
</nav>
  <header class="Header">
    
    <div class="Header__Spacer Header__Spacer--NoCover">
    </div>
    
    <h1 class="Header__Title">分布式事务</h1>
    
  </header>
  <article id="https://www.notion.so/92e418a5a1fb4ae79cc9818206880db3" class="PageRoot"><h2 id="https://www.notion.so/1642cb80e670431ebe85ea738c9ecf7a" class="ColorfulBlock ColorfulBlock--ColorDefault Heading Heading--2"><a class="Anchor" href="#https://www.notion.so/1642cb80e670431ebe85ea738c9ecf7a"><svg width="16" height="16" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><span class="SemanticStringArray"><span class="SemanticString">分布式理论</span></span></h2><h3 id="https://www.notion.so/a9d4da19386a41b9aadcd82340dd80c6" class="ColorfulBlock ColorfulBlock--ColorDefault Heading Heading--3"><a class="Anchor" href="#https://www.notion.so/a9d4da19386a41b9aadcd82340dd80c6"><svg width="16" height="16" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><span class="SemanticStringArray"><span class="SemanticString">CAP</span></span></h3><div id="https://www.notion.so/d178f4f295774416857e74f7738d0b42" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">Consistency: 一致性</span></span></p></div><div id="https://www.notion.so/ddf2727b9a1c4348a658a23ba39e24f1" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">Availability: 可用性</span></span></p></div><div id="https://www.notion.so/fea68768128c4fb280b478b08c70c4e8" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">Paritition: 分区容错性</span></span></p></div><div id="https://www.notion.so/2bbb792226b749678c74602d282c9ef9" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">在保证分区容错性的同时，在可用性和一致性之间做取舍。</span></span></p></div><h3 id="https://www.notion.so/52a63284705f420c82b6a416ec1be52a" class="ColorfulBlock ColorfulBlock--ColorDefault Heading Heading--3"><a class="Anchor" href="#https://www.notion.so/52a63284705f420c82b6a416ec1be52a"><svg width="16" height="16" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><span class="SemanticStringArray"><span class="SemanticString">BASE</span></span></h3><div id="https://www.notion.so/6c2f42efde0b4bd0863b0800ac47db1c" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">Basically Available: 基本可用  ---- 当系统故障时，保证核心可用，允许损失部分可用性</span></span></p></div><div id="https://www.notion.so/3980fac538754d13a0a2a00636e6d9e1" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">Soft State: 软状态 ----  允许系统不同节点的数据副本之间的同步存在时延</span></span></p></div><div id="https://www.notion.so/4a1029c440474f8ab6d66744a443c9cc" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">Eventually Consistent: 最终一致性 ---- 系统所有的数据副本，在经过一段时间的同步后，最终能达到一致的状态</span></span></p></div><h3 id="https://www.notion.so/430af741d814402eabd1b86f1177ff44" class="ColorfulBlock ColorfulBlock--ColorDefault Heading Heading--3"><a class="Anchor" href="#https://www.notion.so/430af741d814402eabd1b86f1177ff44"><svg width="16" height="16" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><span class="SemanticStringArray"><span class="SemanticString">分布式事务</span></span></h3><h3 id="https://www.notion.so/b15351a7199843e7b12d58c7ab323f0d" class="ColorfulBlock ColorfulBlock--ColorDefault Heading Heading--3"><a class="Anchor" href="#https://www.notion.so/b15351a7199843e7b12d58c7ab323f0d"><svg width="16" height="16" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><span class="SemanticStringArray"><span class="SemanticString">两阶段提交协议（Two-phase Commit ，2PC）</span></span></h3><div id="https://www.notion.so/fb5d426adfb04ca3afc0d1d063fa581a" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">通过引入协调者来协调参与者的行为，并最终决定这些参与者是否要真正执行事务。</span></span></p></div><div id="https://www.notion.so/e2c9ffc7c5aa4484a5cddb9911dee537" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString"><strong class="SemanticString__Fragment SemanticString__Fragment--Bold">运行过程</strong></span></span></p></div><ol class="NumberedListWrapper"><li id="https://www.notion.so/80980e8d68194e22ae62eea3c414cad2" class="NumberedList" value="1"><span class="SemanticStringArray"><span class="SemanticString">准备阶段：协调者询问参与者事务是否执行成功，参与者返回事务执行结果</span></span></li><li id="https://www.notion.so/5ed1ace986d6433a9bb9f1374c91542f" class="NumberedList" value="2"><span class="SemanticStringArray"><span class="SemanticString">提交阶段：如果事务在每个参与者上都执行成功，事务协调者发送通知让参与者提交事务；否则，通知参与者回滚事务；</span></span></li></ol><div id="https://www.notion.so/009a0827596444f7b9554310ae3bb370" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString"><strong class="SemanticString__Fragment SemanticString__Fragment--Bold">存在的问题</strong></span></span></p></div><ol class="NumberedListWrapper"><li id="https://www.notion.so/1e1797549dba42da8a6356b4c304c247" class="NumberedList" value="1"><span class="SemanticStringArray"><span class="SemanticString">同步阻塞：所有的事务参与者在等待其他参与者响应的时候都处于同步阻塞状态，无法进行其他操作。</span></span></li><li id="https://www.notion.so/b090ced9b66b4e22ab76471d07110e3f" class="NumberedList" value="2"><span class="SemanticStringArray"><span class="SemanticString">单点问题：协调者在2PC中起到非常大的作用，发生故障的时候回造成很大影响。特别是在提交阶段，所有参与者会一直等待，无法完成其他操作。</span></span></li><li id="https://www.notion.so/936db781244b46649f43fce2032de3da" class="NumberedList" value="3"><span class="SemanticStringArray"><span class="SemanticString">数据不一致：在提交阶段，如果协调者只发送了部分Commit消息，然后发生网络异常，那么只有部分参与者接收commit消息，使得数据不一致。</span></span></li><li id="https://www.notion.so/9e578352bb4849c683747b962f8a2516" class="NumberedList" value="4"><span class="SemanticStringArray"><span class="SemanticString">过于保守：任意一个节点失败都会导致整个事务失败，没有完善的容错机制</span></span></li></ol><h3 id="https://www.notion.so/15a4b856bcc1450d85c58119c34f719e" class="ColorfulBlock ColorfulBlock--ColorDefault Heading Heading--3"><a class="Anchor" href="#https://www.notion.so/15a4b856bcc1450d85c58119c34f719e"><svg width="16" height="16" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><span class="SemanticStringArray"><span class="SemanticString">三阶段提交协议（3PC）</span></span></h3><div id="https://www.notion.so/103a3acea6744b41b16d14b50add9dbd" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">3PC在协调者和参与者中都引入了超时机制，并把两阶段提交协议的第一个阶段拆分成了两步：询问，然后在锁定资源，最后真正提交。</span></span></p></div><ol class="NumberedListWrapper"><li id="https://www.notion.so/0084a75fdcce4c1e8124f489e3eb8a8f" class="NumberedList" value="1"><span class="SemanticStringArray"><span class="SemanticString">cancommit阶段：协调者向参与者放commit请求，参与者如果可以提交就返回YES响应，否则返回NO</span></span></li><li id="https://www.notion.so/24633546140b43a7a7fd9146a62ef93a" class="NumberedList" value="2"><span class="SemanticStringArray"><span class="SemanticString">precommit阶段：协调者根据commit的反应来决定是否继续precommi操作</span></span><div id="https://www.notion.so/0ea11401f36f4b0fad874d143f7e39e9" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">A：如果协调者从所有的参与者获取的commit都是YES响应，那么就会进行事务的预执行（协调者发送预提交请求，并进入prepared阶段）参与者收到precommit请求后，会执行事务操作，并将undo和redo信息记录到事务日志中，如果参与者成功执行事务操作，那么返回ACK响应，同时开始等待最终指令。</span></span></p></div><div id="https://www.notion.so/fab494abd2d94b82846fdaa64b664e3a" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">B:   假如有任何一个参与者向协调者发送了NO响应，或者超时等待之后，协调者都没有接受到参与者的响应，那么中断事务。协调者向所有的参与者发送abort请求，中断事务。参与者接收到abort请求（或者超时之后）执行事务的中断。</span></span></p></div></li><li id="https://www.notion.so/8c9828c29ce8440fac873e087c389eac" class="NumberedList" value="3"><span class="SemanticStringArray"><span class="SemanticString">docommit阶段</span></span><div id="https://www.notion.so/37730bd053214aa8bd717db281b9749b" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">A：发送提交请求：协调者接收到参与者发送的ACK响应，那么他将从预提交状态进入到提交状态，并向所有的参与者发送docommit请求</span></span></p></div><div id="https://www.notion.so/cd1a78edc8f344ed9902fd1585f77e7a" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">B:   事务提交：参与者接收到docommit请求后，执行正式的事务提交，并在完成事务提交后释放所有的事务资源。</span></span></p></div><div id="https://www.notion.so/06e784f5bec8458a800964dbbd346344" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">C:	响应反馈：事务提交完之后，向协调者发送ACK响应。</span></span></p></div><div id="https://www.notion.so/bdefe1773380434e8bff9f006f0b878c" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">D:	完成事务：协调者接收到所有参与者的ACK响应之后，完成事务。</span></span></p></div><div id="https://www.notion.so/0346fea5a8fa4d4392e50f9f86728cbc" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">中断事务：协调者没有接受到参与者发送的ACK响应（或者响应超时），那么就会中断事务。</span></span></p></div></li></ol><div id="https://www.notion.so/64db875963e243d9a64e894020687f2e" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString"><strong class="SemanticString__Fragment SemanticString__Fragment--Bold">存在问题</strong></span></span></p></div><div id="https://www.notion.so/15afcf6d8d2c4cd89c6f846d0d6b1c49" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">如果进入PreCommit后，Coordinator发出的是abort请求，假设只有一个Cohort收到并进行了abort操作，
而其他对于系统状态未知的Cohort会根据3PC选择继续Commit，此时系统状态发生不一致性。</span></span></p></div><div id="https://www.notion.so/807a7c893a3a4e36a65b6f665415095a" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString"><strong class="SemanticString__Fragment SemanticString__Fragment--Bold">2PC和3PC的不同</strong></span></span></p></div><div id="https://www.notion.so/39292c06a35f4127b470e34db8d4e83c" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">对于协调者(Coordinator)和参与者(Cohort)都设置了超时机制（在2PC中，只有协调者拥有超时机制，即如果在一定时间内没有收到cohort的消息则默认失败）。
在2PC的准备阶段和提交阶段之间，插入预提交阶段，使3PC拥有CanCommit、PreCommit、DoCommit三个阶段。
PreCommit是一个缓冲，保证了在最后提交阶段之前各参与节点的状态是一致的。</span></span></p></div><h3 id="https://www.notion.so/cbb50e86e0fa4ff8ab603fea1787c347" class="ColorfulBlock ColorfulBlock--ColorDefault Heading Heading--3"><a class="Anchor" href="#https://www.notion.so/cbb50e86e0fa4ff8ab603fea1787c347"><svg width="16" height="16" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><span class="SemanticStringArray"><span class="SemanticString">Paxos算法</span></span></h3><div id="https://www.notion.so/7db2ddeaf2294d4895c9af8f4e7fa3c0" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">Paxos算法需要解决的问题就是如何在一个可能发生</span><span class="SemanticString"><strong class="SemanticString__Fragment SemanticString__Fragment--Bold">机器宕机</strong></span><span class="SemanticString">或</span><span class="SemanticString"><strong class="SemanticString__Fragment SemanticString__Fragment--Bold">网络异常</strong></span><span class="SemanticString">的分布式系统中，快速且正确地在集群内部对</span><span class="SemanticString"><strong class="SemanticString__Fragment SemanticString__Fragment--Bold">某个数据的值</strong></span><span class="SemanticString">达成</span><span class="SemanticString"><strong class="SemanticString__Fragment SemanticString__Fragment--Bold">一致。</strong></span></span></p></div><div id="https://www.notion.so/115a99b4c2fc4f45ad3c368d27eb94f5" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">Paxos由Acceptor、proposer和leaner三种角色组成</span></span></p></div><ul class="BulletedListWrapper"><li id="https://www.notion.so/04403fafa51146eebf372c0ae4ad67e0" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString">proposer负责提出提案</span></span></li><li id="https://www.notion.so/691957b5c409406ba6fe9da60681e734" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString">acceptor负责对提案裁决</span></span></li><li id="https://www.notion.so/a94f4d207989447da259f8f85ab2e2d3" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString">leaner负责学习得到的提案</span></span></li></ul><div id="https://www.notion.so/cdb349543d714b72a34487e10b092d82" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">为了避免单点故障，会有一个acceptor集合，proposer向该集合发送提案，acceptor集合中的每个成员都有可能同意该提案并且每个acceptor只能批准一个提案，当有一半以上的成员同意，则同意该提案。</span></span></p></div><div id="https://www.notion.so/ca12b3884e3c497abe5fd2eddd484169" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">Paxos算法分为</span><span class="SemanticString"><strong class="SemanticString__Fragment SemanticString__Fragment--Bold">两个阶段</strong></span><span class="SemanticString">。具体如下：</span></span></p></div><ul class="BulletedListWrapper"><li id="https://www.notion.so/97910ad6984149a6baf00f2e4342d688" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString"><strong class="SemanticString__Fragment SemanticString__Fragment--Bold">阶段一：</strong></span></span><div id="https://www.notion.so/91f30cac29d149d6b2aad21dd389d05f" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString"><strong class="SemanticString__Fragment SemanticString__Fragment--Bold">(a)</strong></span><span class="SemanticString"> Proposer选择一个</span><span class="SemanticString"><strong class="SemanticString__Fragment SemanticString__Fragment--Bold">提案编号N</strong></span><span class="SemanticString">，然后向</span><span class="SemanticString"><strong class="SemanticString__Fragment SemanticString__Fragment--Bold">半数以上</strong></span><span class="SemanticString">的Acceptor发送编号为N的</span><span class="SemanticString"><strong class="SemanticString__Fragment SemanticString__Fragment--Bold">Prepare请求</strong></span><span class="SemanticString">。</span></span></p></div><div id="https://www.notion.so/22ccf50172d749da8d374fd519145bee" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString"><strong class="SemanticString__Fragment SemanticString__Fragment--Bold">(b)</strong></span><span class="SemanticString"> 如果一个Acceptor收到一个编号为N的Prepare请求，且N</span><span class="SemanticString"><strong class="SemanticString__Fragment SemanticString__Fragment--Bold">大于</strong></span><span class="SemanticString">该Acceptor已经</span><span class="SemanticString"><strong class="SemanticString__Fragment SemanticString__Fragment--Bold">响应过的</strong></span><span class="SemanticString">所有</span><span class="SemanticString"><strong class="SemanticString__Fragment SemanticString__Fragment--Bold">Prepare请求</strong></span><span class="SemanticString">的编号，那么它就会将它已经</span><span class="SemanticString"><strong class="SemanticString__Fragment SemanticString__Fragment--Bold">接受过的编号最大的提案（如果有的话）</strong></span><span class="SemanticString"><strong class="SemanticString__Fragment SemanticString__Fragment--Bold">作为响应反馈给Proposer，同时该Acceptor承诺</strong></span><span class="SemanticString"><strong class="SemanticString__Fragment SemanticString__Fragment--Bold">不再接受</strong></span><span class="SemanticString">任何</span><span class="SemanticString"><strong class="SemanticString__Fragment SemanticString__Fragment--Bold">编号小于N的提案</strong></span><span class="SemanticString">。</span></span></p></div></li><li id="https://www.notion.so/c65ea5053e7743e495d9a8e38c00efe5" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString"><strong class="SemanticString__Fragment SemanticString__Fragment--Bold">阶段二：</strong></span></span><div id="https://www.notion.so/db619d102981468ba5ade0548309a292" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString"><strong class="SemanticString__Fragment SemanticString__Fragment--Bold">(a)</strong></span><span class="SemanticString"> 如果Proposer收到</span><span class="SemanticString"><strong class="SemanticString__Fragment SemanticString__Fragment--Bold">半数以上</strong></span><span class="SemanticString">Acceptor对其发出的编号为N的Prepare请求的</span><span class="SemanticString"><strong class="SemanticString__Fragment SemanticString__Fragment--Bold">响应</strong></span><span class="SemanticString">，那么它就会发送一个针对**[N,V]提案</span><span class="SemanticString"><strong class="SemanticString__Fragment SemanticString__Fragment--Bold">的</strong></span><span class="SemanticString">Accept请求</span><span class="SemanticString"><strong class="SemanticString__Fragment SemanticString__Fragment--Bold">给</strong></span><span class="SemanticString">半数以上</span><span class="SemanticString"><strong class="SemanticString__Fragment SemanticString__Fragment--Bold">的Acceptor。注意：V就是收到的</strong></span><span class="SemanticString">响应</span><span class="SemanticString"><strong class="SemanticString__Fragment SemanticString__Fragment--Bold">中</strong></span><span class="SemanticString">编号最大的提案的value**，如果响应中</span><span class="SemanticString"><strong class="SemanticString__Fragment SemanticString__Fragment--Bold">不包含任何提案</strong></span><span class="SemanticString">，那么V就由Proposer</span><span class="SemanticString"><strong class="SemanticString__Fragment SemanticString__Fragment--Bold">自己决定</strong></span><span class="SemanticString">。</span></span></p></div><div id="https://www.notion.so/bb9f3bdcd21e4ef58d477abadc7f4310" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString"><strong class="SemanticString__Fragment SemanticString__Fragment--Bold">(b)</strong></span><span class="SemanticString"> 如果Acceptor收到一个针对编号为N的提案的Accept请求，只要该Acceptor</span><span class="SemanticString"><strong class="SemanticString__Fragment SemanticString__Fragment--Bold">没有</strong></span><span class="SemanticString">对编号</span><span class="SemanticString"><strong class="SemanticString__Fragment SemanticString__Fragment--Bold">大于N</strong></span><span class="SemanticString">的</span><span class="SemanticString"><strong class="SemanticString__Fragment SemanticString__Fragment--Bold">Prepare请求</strong></span><span class="SemanticString">做出过</span><span class="SemanticString"><strong class="SemanticString__Fragment SemanticString__Fragment--Bold">响应</strong></span><span class="SemanticString">，它就</span><span class="SemanticString"><strong class="SemanticString__Fragment SemanticString__Fragment--Bold">接受该提案</strong></span><span class="SemanticString">。</span></span></p></div></li></ul><div id="https://www.notion.so/5ee7d659f01e4e3f8269344742d63e22" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">paxos算法是一种基于消息传递的且具有高度容错性的一种算法，解决的问题是一个分布式系统如何就某个值或者某个协议达成一致，该算法的前提是假设不存在拜占庭将军问题。</span></span></p></div><div id="https://www.notion.so/233f2d87f19a4961b4eaa656c896a524" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">在该算法中一共有三种角色：proposer, accpetor和learner。proposer负责提出提案，acceptor负责对该提案做出裁决，learner负责学习得到的提案。为了避免单点故障，会有一个acceptor集合，proposer向该集合发送提案，acceptor集合中的每个成员都有可能同意该提案且每个acceptor只能批准一个提案，当有一半以上的成员同意，则同意该提案。</span></span></p></div><div id="https://www.notion.so/0b0ba3b4efb844ac9ac4f2cd3eecd36a" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">它主要分为两个阶段：分别是prepare阶段和accept阶段。首先是prepare阶段，先由proposer提出编号为Mn的提案，向accpetor集合发送prepare请求。Accept做出反馈：保证不会再接受编号比Mn小的提案；如果acceptor已经批准过某提案，会向proposer返回已经批准的编号最大的提案的value值。</span></span></p></div><div id="https://www.notion.so/a3feb3b540b5426c8414bf662ab7a57a" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">如果acceptor收到一个编号为Mn的请求且编号大于accpetor已经响应的所有prepare请求的编号，则它会将自己已经批准过的编号最大的提案值反馈给proposer，同时acceptor承诺不会再接受编号比Mn小的提案。（优化:忽略编号小于已批准的提案的请求）。</span></span></p></div><div id="https://www.notion.so/f69ad04ef0dc4c249cf72acecc3e6df9" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">如果proposer收到了集合至少一半的响应，则会发送一个针对Mn Vn的accept请求给Accpetor。Vn为收到的所有响应中编号最大的提案的值。如果响应不包括值，则可以由proposer选择任意值。</span></span></p></div><div id="https://www.notion.so/6ef0641ef4264c46be16ea6bc5cab600" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">然后就是accpet阶段，accpet阶段是接受提案的要求。当Acceptor收到accpet请求后，只要未收到任何编号大于Mn的prepare请求，则通过该提案。</span></span></p></div><div id="https://www.notion.so/e1c98e678f1e48c89e9532fab9d0a6b9" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">优化：为了避免死循环，比如两个proposer一次提出一系列编号递增的提案，可以产生一个主proposer，提案只能由主proposer负责提出。</span></span></p></div><div id="https://www.notion.so/4599acad25bc436aa0d6c1e391e92b8e" class="Image Image--PageWidth"><figure><a href="#"><img src="#" style="width:100%"/></a><figcaption><span class="SemanticStringArray"></span></figcaption></figure></div><h3 id="https://www.notion.so/bba974055d8c4cd48cc8b01101aa1aae" class="ColorfulBlock ColorfulBlock--ColorDefault Heading Heading--3"><a class="Anchor" href="#https://www.notion.so/bba974055d8c4cd48cc8b01101aa1aae"><svg width="16" height="16" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><span class="SemanticStringArray"><span class="SemanticString">raft</span></span></h3><div id="https://www.notion.so/eac10e07a23248079543645ef31e8f49" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">Raft 和 Paxos 类似，但是更容易理解，也更容易实现。</span></span></p></div><div id="https://www.notion.so/1a3b112850a7467a8a60800e6e6740e9" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString"><strong class="SemanticString__Fragment SemanticString__Fragment--Bold">Raft 主要是用来竞选主节点</strong></span><span class="SemanticString">。</span></span></p></div><div id="https://www.notion.so/0498204e11ae4c4dbc6d1d537f4db177" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">在Raft中，节点有三种角色：</span></span></p></div><ul class="BulletedListWrapper"><li id="https://www.notion.so/e329cb8c0c3b483d9ea7bc513d97c13d" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString">Leader：负责接收客户端的请求，将日志复制到其他节点并告知其他节点何时应用这些日志是安全的</span></span></li><li id="https://www.notion.so/d47145d769c546a2a95dffbc56b0cd64" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString">Candidate：用于选举Leader的一种角色</span></span></li><li id="https://www.notion.so/d60902da24814a8491d78ad42f44e546" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString">Follower：负责响应来自Leader或者Candidate的请求</span></span></li></ul><div id="https://www.notion.so/6f4c26ef03374a47b2b811660bca8f60" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString"><strong class="SemanticString__Fragment SemanticString__Fragment--Bold">单个 Candidate 的竞选</strong></span></span></p></div><div id="https://www.notion.so/45fa9e6d48654d3ca58fe4418d06bf95" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">有三种节点：Follower、Candidate 和 Leader。Leader 会周期性的发送心跳包给 Follower。每个 Follower 都设置了一个随机的竞选超时时间，一般为 150ms~300ms，如果在这个时间内没有收到 Leader 的心跳包，就会变成 Candidate，进入竞选阶段。</span></span></p></div><div id="https://www.notion.so/956025f404b84e7eaf10341431a36e35" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">下图表示一个分布式系统的最初阶段，此时只有 Follower，没有 Leader。Follower A 等待一个随机的竞选超时时间之后，没收到 Leader 发来的心跳包，因此进入竞选阶段。</span></span></p></div><div id="https://www.notion.so/13a37c18b43546a5a9a5f4b55d1e0bf3" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">此时 A 发送投票请求给其它所有节点。</span></span></p></div><div id="https://www.notion.so/9a593c9379ea4d6ba51e845f21042b30" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">其它节点会对请求进行回复，如果超过一半的节点回复了，那么该 Candidate 就会变成 Leader。</span></span></p></div><div id="https://www.notion.so/501953a407aa48be9ee469588caea7ca" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">之后 Leader 会周期性地发送心跳包给 Follower，Follower 接收到心跳包，会重新开始计时。</span></span></p></div><div id="https://www.notion.so/d9dc524c131f450395f9e313bb8a39fe" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString"><strong class="SemanticString__Fragment SemanticString__Fragment--Bold">多个 Candidate 竞选</strong></span></span></p></div><div id="https://www.notion.so/dc227cb9f4264ae386d22c08c5336385" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">如果有多个 Follower 成为 Candidate，并且所获得票数相同，那么就需要重新开始投票，例如下图中 Candidate B 和 Candidate D 都获得两票，因此需要重新开始投票。</span></span></p></div><div id="https://www.notion.so/1c218e96d2eb41d1acaa981bb7a72352" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">当重新开始投票时，由于每个节点设置的</span><span class="SemanticString"><strong class="SemanticString__Fragment SemanticString__Fragment--Bold">随机竞选超时时间不同</strong></span><span class="SemanticString">，因此能下一次再次出现多个 Candidate 并获得同样票数的概率很低。</span></span></p></div><div id="https://www.notion.so/2bb13464ef7a4d7dbe52f7ddb8ba2b0b" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString"><strong class="SemanticString__Fragment SemanticString__Fragment--Bold">日志复制</strong></span></span></p></div><div id="https://www.notion.so/2fd9a554b5a44267ba2ece0e1e2c951c" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">来自客户端的修改都会被传入 Leader。注意该修改还未被提交，只是写入日志中。</span></span></p></div><div id="https://www.notion.so/14c77da459814630bb07256cfff262dc" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">Leader 会把修改复制到所有 Follower。</span></span></p></div><div id="https://www.notion.so/29ff5a6b6e1948fbb24134a12c839658" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">Leader 会等待大多数的 Follower 也进行了修改，然后才将修改提交。</span></span></p></div><div id="https://www.notion.so/3d063fb9e3b74ce39ed179597de68572" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">此时 Leader 会通知的所有 Follower 让它们也提交修改，此时所有节点的值达成一致。</span></span></p></div><h3 id="https://www.notion.so/bec063e7e6a14bf88e06ca7cc0995ce8" class="ColorfulBlock ColorfulBlock--ColorDefault Heading Heading--3"><a class="Anchor" href="#https://www.notion.so/bec063e7e6a14bf88e06ca7cc0995ce8"><svg width="16" height="16" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><span class="SemanticStringArray"><span class="SemanticString">zookeeper的ZAB算法</span></span></h3><ul class="BulletedListWrapper"><li id="https://www.notion.so/b2a5654782cd4b6aa60e48a02b4b8a63" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString">*Looking：**选举状态。</span></span></li><li id="https://www.notion.so/80e81a0a330f4d76a92f257841a98dcc" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString">*Following：**Follower 节点（从节点）所处的状态。</span></span></li><li id="https://www.notion.so/7e18941479ed477694b1fd880afe95fa" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString">*Leading：**Leader 节点（主节点）所处状态。</span></span></li></ul><div id="https://www.notion.so/f978104c497748abac79b6cefdfb723b" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">最大 ZXID 也就是节点本地的最新事务编号，包含 epoch 和计数两部分。epoch 是纪元的意思，相当于 Raft 算法选主时候的 term。</span></span></p></div><div id="https://www.notion.so/c225a61669574ef7add91fb560507436" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString"><strong class="SemanticString__Fragment SemanticString__Fragment--Bold">崩溃恢复流程：</strong></span></span></p></div><div id="https://www.notion.so/c524a863c25f4d76b38132335861e7ad" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString"><strong class="SemanticString__Fragment SemanticString__Fragment--Bold">1.Leader election</strong></span></span></p></div><div id="https://www.notion.so/2e62a2c9d23541dbaf6e830c5d875b2c" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">			选举阶段，此时集群中的节点处于 Looking 状态。它们会各自向其他节点发起投票，投票当中包含自己的服务器 ID 和最新事务 ID（ZXID）。</span></span></p></div><div id="https://www.notion.so/5b8e2449c5fb4a6db2979d5877d8b028" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">			接下来，节点会用自身的 ZXID 和从其他节点接收到的 ZXID 做比较，如果发现别人家的 ZXID 比自己大，也就是数据比自己新，那么就重新发起投票，投票给目前已知最大的 ZXID 所属节点。</span></span></p></div><div id="https://www.notion.so/0f7b54878f9248cdb6ac9a985fe07700" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">			每次投票后，服务器都会统计投票数量，判断是否有某个节点得到半数以上的投票。如果存在这样的节点，该节点将会成为准 Leader，状态变为 Leading。其他节点的状态变为 Following。</span></span></p></div><div id="https://www.notion.so/f01c76bab68c43a086696569ac1fa1c2" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString"><strong class="SemanticString__Fragment SemanticString__Fragment--Bold">2. Discovery</strong></span></span></p></div><div id="https://www.notion.so/ec435c5c86034b50a5d95a6cc7a927ad" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">		发现阶段，用于在从节点中发现最新的 ZXID 和事务日志。或许有人会问：既然 Leader 被选为主节点，已经是集群里数据最新的了，为什么还要从节点中寻找最新事务呢？</span></span></p></div><div id="https://www.notion.so/3e79778573474d2fbb734a196f7ee313" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">		这是为了防止某些意外情况，比如因网络原因在上一阶段产生多个 Leader 的情况。</span></span></p></div><div id="https://www.notion.so/84a149e7bdf6441facca9c3d65a91afa" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">		所以这一阶段，Leader 集思广益，接收所有 Follower 发来各自的最新 epoch 值。Leader 从中选出最大的 epoch，基于此值加 1，生成新的 epoch 分发给各个 Follower。</span></span></p></div><div id="https://www.notion.so/4f848ceca6a24a1ea4372042d739faaa" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">		各个 Follower 收到全新的 epoch 后，返回 ACK 给 Leader，带上各自最大的 ZXID 和历史事务日志。Leader 选出最大的 ZXID，并更新自身历史日志。</span></span></p></div><div id="https://www.notion.so/7606792c4963422ba928d00ba659ce19" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString"><strong class="SemanticString__Fragment SemanticString__Fragment--Bold">3. Synchronization</strong></span></span></p></div><div id="https://www.notion.so/b5454ee5c45848cf93427b2127d37ca9" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">		同步阶段，把 Leader 刚才收集得到的最新历史事务日志，同步给集群中所有的 Follower。只有当半数 Follower 同步成功，这个准 Leader 才能成为正式的 Leader。</span></span></p></div><div id="https://www.notion.so/1182675d627d4bd88ca5f35ff089ddd0" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString"><strong class="SemanticString__Fragment SemanticString__Fragment--Bold">原子广播</strong></span></span></p></div><ol class="NumberedListWrapper"><li id="https://www.notion.so/0a208aad262b404d8bca5aff421c94cd" class="NumberedList" value="1"><span class="SemanticStringArray"><span class="SemanticString">客户端发出写入数据请求给任意Follower。</span></span></li><li id="https://www.notion.so/03ce8d51585c4d789ec34edcd6c084d1" class="NumberedList" value="2"><span class="SemanticStringArray"><span class="SemanticString">Follower 把写入数据请求转发给 Leader。</span></span></li><li id="https://www.notion.so/cadd625849a044219040e421b9c72b98" class="NumberedList" value="3"><span class="SemanticStringArray"><span class="SemanticString">Leader 采用二阶段提交方式，先发送 Propose 广播给 Follower。</span></span></li><li id="https://www.notion.so/4b6f5ca7f8964e2696733b2b3111d9c5" class="NumberedList" value="4"><span class="SemanticStringArray"><span class="SemanticString">Follower 接到 Propose 消息，写入日志成功后，返回 ACK 消息给 Leader。</span></span></li><li id="https://www.notion.so/5fad9d32be7b4754a7b678a978fe6a6a" class="NumberedList" value="5"><span class="SemanticStringArray"><span class="SemanticString">Leader 接到半数以上 ACK 消息，返回成功给客户端，并且广播 Commit 请求给 Follower。</span></span></li></ol><div id="https://www.notion.so/7ec370060d5c46f389872f47e0a79f4b" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">ZAB 协议既不是强一致性，也不是弱一致性，而是处于两者之间的单调一致性。它依靠事务 ID 和版本号，保证了数据的更新和读取是有序的。</span></span></p></div></article>
  <footer class="Footer">
  <div>&copy; 夕的博客 2022</div>
  <div>&centerdot;</div>
  <div>Powered by <a href="https://github.com/dragonman225/notablog" target="_blank"
      rel="noopener noreferrer">Notablog</a>.
  </div>
</footer>
</body>

</html>